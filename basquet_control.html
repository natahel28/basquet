<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.svg">
    <title>Control de Pagos B√°squet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.267);
        }

        /* Botones de Categor√≠a */
        .category-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .category-btn:active {
            transform: scale(0.98);
            background: #f3f4f6;
        }

        .category-btn.selected {
            border-color: #667eea;
            background: #eef2ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Bot√≥n Principal */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            width: 100%;
            border: none;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Tabs (Pesta√±as) */
        .tab {
            flex: 1;
            padding: 16px 8px;
            text-align: center;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-size: 14px;
            cursor: pointer;
        }

        .tab.active {
            color: white;
            border-bottom-color: white;
        }

        /* Inputs */
        input[type="date"],
        input[type="number"],
        input[type="text"] {
            font-size: 16px;
            padding: 14px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            width: 100%;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Animaciones */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Capa de fondo Modal */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
        }

        /* Notificaci√≥n Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1f2937;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>
    <div id="app" class="min-h-screen pb-20">
        <!-- Encabezado -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 shadow-lg relative">
            <h1 class="text-2xl font-bold text-center flex items-center justify-center gap-2">
                <i data-lucide="dumbbell"></i> Pagos B√°squet
            </h1>
            <p id="current-month-display" class="text-center text-sm mt-1 opacity-90"></p>
        </div>

        <!-- Navegaci√≥n por Pesta√±as -->
        <div class="flex bg-gradient-to-r from-purple-600 to-indigo-600 sticky top-0 z-40 shadow-md">
            <button class="tab active" data-tab="input">‚ûï A√±adir</button>
            <button class="tab" data-tab="summary">üìä Resumen</button>
            <button class="tab" data-tab="history">üìÖ Historial</button>
            <button class="tab" data-tab="config">‚öôÔ∏è Config</button>
        </div>

        <!-- SECCI√ìN 1: A√ëADIR PARTIDO -->
        <div id="section-input" class="section p-4 fade-in">
            <!-- Selector de Fecha -->
            <div class="glass rounded-2xl p-5 mb-4 shadow-lg">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Fecha del Partido</label>
                <input type="date" id="input-date">
            </div>

            <!-- Lista de Categor√≠as -->
            <div class="glass rounded-2xl p-5 mb-4 shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <label class="font-semibold text-gray-700">Seleccionar Categor√≠a</label>
                    <button id="refresh-categories" class="text-purple-600 text-sm font-medium hover:underline">
                        üîÑ Actualizar
                    </button>
                </div>
                <div id="categories-container" class="max-h-96 overflow-y-auto pr-1">
                    <!-- Se inyecta con JS -->
                </div>
            </div>

            <!-- √Årea de Acci√≥n (Bot√≥n Flotante) -->
            <div id="action-area"
                class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur border-t z-30 transform transition-transform duration-300 translate-y-full">
                <div class="max-w-md mx-auto">
                    <div class="flex justify-between items-end mb-3">
                        <span class="text-gray-600 text-sm">Pago:</span>
                        <span id="selected-payment" class="text-3xl font-bold text-green-600">$0</span>
                    </div>
                    <button id="save-btn" class="btn-primary flex justify-center items-center gap-2">
                        <span>Guardar Partido</span>
                        <i data-lucide="check-circle" width="20"></i>
                    </button>
                    <button id="cancel-edit-btn" class="mt-2 w-full text-gray-500 py-2 hidden">Cancelar Edici√≥n</button>
                </div>
            </div>

            <!-- Lista Partidos Mes Actual -->
            <div class="glass rounded-2xl p-5 mb-16 shadow-lg">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i data-lucide="list"></i> Partidos de Este Mes
                </h3>
                <div id="matches-list" class="space-y-3">
                    <!-- Se inyecta con JS -->
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 2: RESUMEN -->
        <div id="section-summary" class="section p-4 hidden fade-in">
            <!-- Tarjetas de Totales -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="glass p-3 rounded-xl text-center">
                    <div class="text-xs text-gray-500 uppercase font-bold">Partidos</div>
                    <div id="sum-count" class="text-2xl font-bold text-purple-600">0</div>
                </div>
                <div class="glass p-3 rounded-xl text-center">
                    <div class="text-xs text-gray-500 uppercase font-bold">Bruto</div>
                    <div id="sum-gross" class="text-2xl font-bold text-green-600">$0</div>
                </div>
                <div class="glass p-3 rounded-xl text-center">
                    <div class="text-xs text-gray-500 uppercase font-bold">Ret. 5%</div>
                    <div id="sum-retention" class="text-2xl font-bold text-red-500">$0</div>
                </div>
                <!-- Card Neto destacada -->
                <div
                    class="bg-gradient-to-br from-yellow-100 to-amber-200 p-3 rounded-xl text-center border-2 border-yellow-400 shadow-yellow-200 shadow-lg">
                    <div class="text-xs text-yellow-800 uppercase font-bold">Total Neto</div>
                    <div id="sum-net" class="text-2xl font-extrabold text-yellow-900">$0</div>
                </div>
            </div>

            <!-- Desglose por Categor√≠a -->
            <div class="glass rounded-2xl p-5 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Desglose por Categor√≠a</h3>
                    <button id="export-btn" class="text-purple-600 text-sm font-medium flex items-center gap-1">
                        <i data-lucide="download" width="16"></i> Exportar
                    </button>
                </div>
                <div id="summary-breakdown" class="space-y-4">
                    <!-- Se inyecta con JS -->
                </div>
            </div>
        </div>

        <!-- SECCI√ìN 3: HISTORIAL -->
        <div id="section-history" class="section p-4 hidden fade-in">
            <div class="glass rounded-2xl p-5 shadow-lg mb-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Seleccionar Mes</h3>
                <div id="history-months-list" class="space-y-2"></div>
            </div>
            <!-- Detalle Hist√≥rico (similar a resumen) -->
            <div id="history-detail" class="hidden">
                <button onclick="document.getElementById('history-detail').classList.add('hidden')"
                    class="mb-4 text-purple-600 font-medium flex items-center gap-1">
                    <i data-lucide="arrow-left" width="16"></i> Volver
                </button>
                <div id="history-content"></div>
            </div>
        </div>

        <!-- SECCI√ìN 4: CONFIGURACI√ìN -->
        <div id="section-config" class="section p-4 hidden fade-in">
            <div class="glass rounded-2xl p-5 shadow-lg mb-4">
                <h3 class="text-lg font-bold text-gray-800 mb-2">Precios y Categor√≠as</h3>
                <p class="text-sm text-gray-500 mb-4">Ajusta los valores de cada categor√≠a aqu√≠.</p>

                <div id="config-list" class="space-y-3">
                    <!-- Config items inyectados -->
                </div>

                <button id="add-category-btn"
                    class="mt-4 w-full py-3 border-2 border-dashed border-purple-300 text-purple-600 rounded-xl font-medium hover:bg-purple-50 transition-colors">
                    + Agregar Nueva Categor√≠a
                </button>
            </div>

            <div class="text-center text-xs text-gray-400 mt-8">
                Versi√≥n 2.0 - Almacenamiento Local
            </div>
        </div>
    </div>

    <!-- MODAL (Gen√©rico) -->
    <div id="modal"
        class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl transform scale-95 transition-transform duration-300"
            id="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-2">T√≠tulo</h3>
            <p id="modal-body" class="text-gray-600 mb-6">Mensaje...</p>
            <div class="flex gap-3 justify-end">
                <button id="modal-cancel"
                    class="px-4 py-2 rounded-lg text-gray-600 font-medium hover:bg-gray-100">Cancelar</button>
                <button id="modal-confirm"
                    class="px-4 py-2 rounded-lg bg-purple-600 text-white font-medium hover:bg-purple-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR CATEGOR√çA -->
    <div id="modal-cat" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Editar Categor√≠a</h3>
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                <input type="text" id="edit-cat-name" placeholder="Ej: U17">
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Precio</label>
                <input type="number" id="edit-cat-price" placeholder="Ej: 18000">
            </div>
            <div class="flex gap-3">
                <button onclick="interfazUsuario.cerrarModal('modal-cat')"
                    class="flex-1 py-3 text-gray-600 bg-gray-100 rounded-xl font-medium">Cancelar</button>
                <button id="save-cat-btn"
                    class="flex-1 py-3 bg-purple-600 text-white rounded-xl font-medium shadow-lg shadow-purple-200">Guardar</button>
            </div>
        </div>
    </div>

    <!-- TOAST (Notificaci√≥n) -->
    <div id="toast" class="toast">
        <i data-lucide="check" width="18"></i>
        <span id="toast-msg">Acci√≥n realizada</span>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN INICIAL Y DATOS POR DEFECTO
        // ==========================================
        const CATEGORIAS_POR_DEFECTO = [
            { id: 1, name: "U13-14-15", payment: 16000 },
            { id: 2, name: "U17", payment: 18000 },
            { id: 3, name: "U19", payment: 20000 },
            { id: 4, name: "1¬™ FEM", payment: 21000 },
            { id: 5, name: "1¬™ CAT B", payment: 24000 },
            { id: 6, name: "1¬™ CAT A", payment: 27000 },
            { id: 7, name: "2¬™-INTERMEDIA", payment: 25000 },
            { id: 8, name: "PRE MINI", payment: 8500 },
            { id: 9, name: "MINI B", payment: 10500 },
            { id: 10, name: "MINI FEM", payment: 10500 },
            { id: 11, name: "U11- MINI A", payment: 13000 },
            { id: 12, name: "LIGA ESC MENORES", payment: 14000 },
            { id: 13, name: "LIGA ESC MAYORES", payment: 15500 },
            { id: 14, name: "A OTAMENDI", payment: 7000 },
            { id: 15, name: "A MIRAMAR", payment: 7000 },
        ];

        // ==========================================
        // CLASE: ESTADO DE LA APLICACI√ìN (DATOS)
        // ==========================================
        class EstadoAplicacion {
            constructor() {
                this.claveAlmacenamiento = 'basquetMatches_v3';
                this.claveConfiguracion = 'basquetConfig_v1';
                this.partidos = {};
                this.categorias = [];
                this.cargar();
            }

            cargar() {
                // Cargar Partidos desde localStorage
                const datosPartidos = localStorage.getItem(this.claveAlmacenamiento);
                try {
                    this.partidos = datosPartidos ? JSON.parse(datosPartidos) : {};
                    // Migraci√≥n de v2 si existe y v3 no
                    if (!datosPartidos && localStorage.getItem('basquetMatchesARS_v2')) {
                        console.log("Migrando datos de versi√≥n anterior...");
                        this.partidos = JSON.parse(localStorage.getItem('basquetMatchesARS_v2'));
                    }
                } catch (e) { this.partidos = {}; }

                // Cargar Configuraci√≥n (Categor√≠as)
                const datosConfig = localStorage.getItem(this.claveConfiguracion);
                try {
                    this.categorias = datosConfig ? JSON.parse(datosConfig) : [...CATEGORIAS_POR_DEFECTO];
                } catch (e) { this.categorias = [...CATEGORIAS_POR_DEFECTO]; }
            }

            guardar() {
                localStorage.setItem(this.claveAlmacenamiento, JSON.stringify(this.partidos));
            }

            guardarConfiguracion() {
                localStorage.setItem(this.claveConfiguracion, JSON.stringify(this.categorias));
            }

            // --- M√©todos de Partidos ---
            obtenerPartidos(claveMes) {
                return this.partidos[claveMes] || [];
            }

            agregarPartido(fecha, nombreCategoria, pago) {
                const claveMes = fecha.substring(0, 7); // "YYYY-MM"
                const nuevoPartido = {
                    id: Date.now(),
                    date: fecha,
                    category: nombreCategoria,
                    payment: parseInt(pago)
                };
                if (!this.partidos[claveMes]) this.partidos[claveMes] = [];
                this.partidos[claveMes].push(nuevoPartido);
                this.guardar();
                return nuevoPartido;
            }

            eliminarPartido(id, claveMes) {
                if (!this.partidos[claveMes]) return;
                this.partidos[claveMes] = this.partidos[claveMes].filter(p => p.id !== id);
                this.guardar();
            }

            actualizarPartido(id, claveMes, nuevaFecha, nuevaCat, nuevoPago) {
                const lista = this.partidos[claveMes];
                const indice = lista.findIndex(p => p.id === id);
                if (indice !== -1) {
                    // Verificar si cambi√≥ de mes
                    const nuevaClaveMes = nuevaFecha.substring(0, 7);
                    if (nuevaClaveMes !== claveMes) {
                        this.eliminarPartido(id, claveMes);
                        this.agregarPartido(nuevaFecha, nuevaCat, nuevoPago);
                    } else {
                        lista[indice].date = nuevaFecha;
                        lista[indice].category = nuevaCat;
                        lista[indice].payment = parseInt(nuevoPago);
                        this.guardar();
                    }
                }
            }

            // --- M√©todos de Configuraci√≥n ---
            actualizarCategoria(nombreAnterior, nuevoNombre, nuevoPrecio) {
                const indice = this.categorias.findIndex(c => c.name === nombreAnterior);
                if (indice !== -1) {
                    this.categorias[indice].name = nuevoNombre;
                    this.categorias[indice].payment = parseInt(nuevoPrecio);
                    this.guardarConfiguracion();
                }
            }

            agregarCategoria(nombre, precio) {
                this.categorias.push({ id: Date.now(), name: nombre, payment: parseInt(precio) });
                this.guardarConfiguracion();
            }

            eliminarCategoria(nombre) {
                this.categorias = this.categorias.filter(c => c.name !== nombre);
                this.guardarConfiguracion();
            }
        }

        // ==========================================
        // CLASE: INTERFAZ DE USUARIO (UI)
        // ==========================================
        class InterfazUsuario {
            constructor(estado) {
                this.estado = estado;
                this.categoriaSeleccionada = null;
                this.idPartidoEditando = null;
                this.mesActual = new Date().toISOString().substring(0, 7);

                // Elementos del DOM
                this.elementos = {
                    inputFecha: document.getElementById('input-date'),
                    contenedorCat: document.getElementById('categories-container'),
                    listaPartidos: document.getElementById('matches-list'),
                    areaAccion: document.getElementById('action-area'),
                    botonGuardar: document.getElementById('save-btn'),
                    botonCancelarEdicion: document.getElementById('cancel-edit-btn'),
                    displayPago: document.getElementById('selected-payment'),
                    sumaCantidad: document.getElementById('sum-count'),
                    sumaBruto: document.getElementById('sum-gross'),
                    sumaRetencion: document.getElementById('sum-retention'),
                    sumaNeto: document.getElementById('sum-net'),
                    listaConfig: document.getElementById('config-list'),
                    modal: document.getElementById('modal'),
                    contenidoModal: document.getElementById('modal-content'),
                };

                this.iniciar();
            }

            iniciar() {
                // Establecer fecha actual por defecto
                this.elementos.inputFecha.valueAsDate = new Date();

                // L√≥gica de pesta√±as
                document.querySelectorAll('.tab').forEach(btn => {
                    btn.addEventListener('click', (e) => this.cambiarPestana(e.target.dataset.tab));
                });

                // Listeners (Escuchadores de eventos)
                this.elementos.botonGuardar.addEventListener('click', () => this.manejarGuardado());
                document.getElementById('refresh-categories').addEventListener('click', () => this.renderizarCategorias());
                document.getElementById('add-category-btn').addEventListener('click', () => this.abrirModalCategoria());
                document.getElementById('save-cat-btn').addEventListener('click', () => this.guardarModalCategoria());
                document.getElementById('cancel-edit-btn').addEventListener('click', () => this.reiniciarEntrada());
                document.getElementById('export-btn').addEventListener('click', () => this.exportarDatos());

                this.actualizarEncabezadoMes();
                this.renderizarCategorias();
                this.renderizarPartidos();
                lucide.createIcons();
            }

            cambiarPestana(idPestana) {
                document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
                document.getElementById('section-' + idPestana).classList.remove('hidden');

                document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
                document.querySelector(`.tab[data-tab="${idPestana}"]`).classList.add('active');

                if (idPestana === 'summary') this.renderizarResumen();
                if (idPestana === 'history') this.renderizarHistorial();
                if (idPestana === 'config') this.renderizarConfiguracion();
            }

            // --- L√≥gica de Renderizado ---

            renderizarCategorias() {
                this.elementos.contenedorCat.innerHTML = '';
                this.estado.categorias.forEach(cat => {
                    const btn = document.createElement('div');
                    btn.className = `category-btn flex justify-between items-center ${this.categoriaSeleccionada?.name === cat.name ? 'selected' : ''}`;
                    btn.innerHTML = `
                         <div class="font-semibold text-gray-800">${cat.name}</div>
                         <div class="font-bold text-purple-600">${this.formatearDinero(cat.payment)}</div>
                    `;
                    btn.onclick = () => this.seleccionarCategoria(cat, btn);
                    this.elementos.contenedorCat.appendChild(btn);
                });
            }

            seleccionarCategoria(cat, elementoBtn) {
                this.categoriaSeleccionada = cat;
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
                elementoBtn.classList.add('selected');

                this.elementos.displayPago.textContent = this.formatearDinero(cat.payment);
                this.elementos.areaAccion.classList.remove('translate-y-full'); // Mostrar √°rea de acci√≥n
            }

            renderizarPartidos() {
                const partidos = this.estado.obtenerPartidos(this.mesActual);
                const contenedor = this.elementos.listaPartidos;
                contenedor.innerHTML = '';

                if (partidos.length === 0) {
                    contenedor.innerHTML = `<div class="text-center text-gray-400 py-8 flex flex-col items-center"><i data-lucide="clipboard-x" class="mb-2"></i> No hay partidos</div>`;
                    lucide.createIcons();
                    return;
                }

                // Ordenar por fecha descendente
                partidos.sort((a, b) => new Date(b.date) - new Date(a.date));

                partidos.forEach(partido => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center fade-in';
                    const fechaFmt = new Date(partido.date + 'T00:00:00').toLocaleDateString('es-AR', { day: '2-digit', month: 'short' });

                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="bg-purple-100 text-purple-700 font-bold rounded-lg px-3 py-1 text-xs text-center">
                                ${fechaFmt}
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">${partido.category}</div>
                                <div class="text-xs text-gray-500">Pago: ${this.formatearDinero(partido.payment)}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button class="p-2 text-gray-400 hover:text-blue-600 bg-gray-50 rounded-lg" onclick="interfazUsuario.iniciarEdicion(${partido.id})">
                                <i data-lucide="edit-2" width="16"></i>
                             </button>
                             <button class="p-2 text-gray-400 hover:text-red-600 bg-gray-50 rounded-lg" onclick="interfazUsuario.confirmarEliminacion(${partido.id})">
                                <i data-lucide="trash-2" width="16"></i>
                             </button>
                        </div>
                    `;
                    contenedor.appendChild(el);
                });
                lucide.createIcons();
            }

            // --- L√≥gica Principal ---

            manejarGuardado() {
                const fecha = this.elementos.inputFecha.value;
                if (!fecha || !this.categoriaSeleccionada) {
                    this.mostrarToast('‚ö†Ô∏è Faltan datos', 'error');
                    return;
                }

                if (this.idPartidoEditando) {
                    // Actualizar existente
                    this.estado.actualizarPartido(this.idPartidoEditando, this.mesActual, fecha, this.categoriaSeleccionada.name, this.categoriaSeleccionada.payment);
                    this.mostrarToast('Partido actualizado');
                } else {
                    // Crear nuevo
                    this.estado.agregarPartido(fecha, this.categoriaSeleccionada.name, this.categoriaSeleccionada.payment);
                    this.mostrarToast('Partido guardado');
                }

                this.reiniciarEntrada();
                this.renderizarPartidos();
            }

            reiniciarEntrada() {
                this.categoriaSeleccionada = null;
                this.idPartidoEditando = null;
                this.elementos.areaAccion.classList.add('translate-y-full');
                this.elementos.botonCancelarEdicion.classList.add('hidden');
                this.elementos.botonGuardar.innerHTML = `<span>Guardar Partido</span> <i data-lucide="check-circle" width="20"></i>`;
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
                lucide.createIcons();
            }

            iniciarEdicion(id) {
                const partidos = this.estado.obtenerPartidos(this.mesActual);
                const partido = partidos.find(p => p.id === id);
                if (!partido) return;

                this.elementos.inputFecha.value = partido.date;
                this.idPartidoEditando = id;

                // Encontrar categor√≠a correspondiente
                const objCat = this.estado.categorias.find(c => c.name === partido.category) || { name: partido.category, payment: partido.payment };
                this.categoriaSeleccionada = objCat;

                // Cambios en UI
                this.renderizarCategorias();

                this.elementos.displayPago.textContent = this.formatearDinero(partido.payment);
                this.elementos.areaAccion.classList.remove('translate-y-full');
                this.elementos.botonCancelarEdicion.classList.remove('hidden');
                this.elementos.botonGuardar.innerHTML = `<span>Actualizar Partido</span> <i data-lucide="refresh-cw" width="20"></i>`;
                lucide.createIcons();

                // Scroll arriba
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            confirmarEliminacion(id) {
                this.mostrarModal('¬øEliminar partido?', 'Esta acci√≥n no se puede deshacer.', () => {
                    this.estado.eliminarPartido(id, this.mesActual);
                    this.renderizarPartidos();
                    this.mostrarToast('Partido eliminado');
                });
            }

            // --- L√≥gica de Resumen ---
            renderizarResumen() {
                const partidos = this.estado.obtenerPartidos(this.mesActual);
                const estadisticas = this.calcularEstadisticas(partidos);

                this.elementos.sumaCantidad.textContent = estadisticas.cantidad;
                this.elementos.sumaBruto.textContent = this.formatearDinero(estadisticas.bruto);
                this.elementos.sumaRetencion.textContent = this.formatearDinero(estadisticas.retencion);
                this.elementos.sumaNeto.textContent = this.formatearDinero(estadisticas.neto);

                const contenedor = document.getElementById('summary-breakdown');
                contenedor.innerHTML = '';

                Object.entries(estadisticas.porCategoria).forEach(([nombre, datos]) => {
                    const fila = document.createElement('div');
                    fila.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100';
                    fila.innerHTML = `
                        <div>
                            <div class="font-semibold text-gray-800">${nombre}</div>
                            <div class="text-xs text-gray-500">${datos.cantidad} partidos x ${this.formatearDinero(datos.unitario)}</div>
                        </div>
                        <div class="text-right">
                             <div class="font-bold text-green-600">${this.formatearDinero(datos.bruto)}</div>
                             <div class="text-xs text-orange-600">Neto: ${this.formatearDinero(datos.neto)}</div>
                        </div>
                    `;
                    contenedor.appendChild(fila);
                });
            }

            calcularEstadisticas(partidos) {
                let stats = { cantidad: 0, bruto: 0, retencion: 0, neto: 0, porCategoria: {} };
                partidos.forEach(p => {
                    stats.cantidad++;
                    stats.bruto += p.payment;

                    if (!stats.porCategoria[p.category]) {
                        stats.porCategoria[p.category] = { cantidad: 0, bruto: 0, unitario: p.payment, neto: 0 };
                    }
                    stats.porCategoria[p.category].cantidad++;
                    stats.porCategoria[p.category].bruto += p.payment;
                });

                stats.retencion = stats.bruto * 0.05;
                stats.neto = stats.bruto - stats.retencion;

                // Calcular neto por categor√≠a
                Object.keys(stats.porCategoria).forEach(k => {
                    const c = stats.porCategoria[k];
                    c.neto = c.bruto - (c.bruto * 0.05);
                });

                return stats;
            }

            // --- L√≥gica de Historial ---
            renderizarHistorial() {
                const lista = document.getElementById('history-months-list');
                lista.innerHTML = '';
                const meses = Object.keys(this.estado.partidos).sort().reverse();

                meses.forEach(claveMes => {
                    const partidos = this.estado.partidos[claveMes];
                    const stats = this.calcularEstadisticas(partidos);

                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-xl border border-gray-200 flex justify-between items-center cursor-pointer hover:bg-gray-50';
                    item.innerHTML = `
                        <div>
                             <div class="font-bold text-lg">${this.formatearMes(claveMes)}</div>
                             <div class="text-sm text-gray-500">${stats.cantidad} partidos</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-uppercase text-gray-400 font-bold">NETO</div>
                            <div class="font-bold text-green-600 text-lg">${this.formatearDinero(stats.neto)}</div>
                        </div>
                    `;
                    item.onclick = () => this.mostrarDetalleHistorial(claveMes, stats, partidos);
                    lista.appendChild(item);
                });
            }

            mostrarDetalleHistorial(claveMes, stats, partidos) {
                this.mostrarToast('Detalle de mes cargado (demo)');
                // Implementaci√≥n simplificada
            }

            // --- L√≥gica de Configuraci√≥n ---
            renderizarConfiguracion() {
                const lista = this.elementos.listaConfig;
                lista.innerHTML = '';
                this.estado.categorias.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200';
                    item.innerHTML = `
                        <div>
                            <div class="font-semibold">${cat.name}</div>
                            <div class="text-sm text-green-600 font-bold">${this.formatearDinero(cat.payment)}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="p-2 text-gray-400 hover:text-blue-600" onclick="interfazUsuario.abrirEditarCategoria('${cat.name}', ${cat.payment})"><i data-lucide="edit-3" width="18"></i></button>
                            <button class="p-2 text-gray-400 hover:text-red-600" onclick="interfazUsuario.eliminarCategoria('${cat.name}')"><i data-lucide="trash" width="18"></i></button>
                        </div>
                    `;
                    lista.appendChild(item);
                });
                lucide.createIcons();
            }

            // L√≥gica de Modales
            _nombreCatTemporal = null;

            abrirEditarCategoria(nombre, precio) {
                this._nombreCatTemporal = nombre;
                document.getElementById('edit-cat-name').value = nombre;
                document.getElementById('edit-cat-price').value = precio;
                document.getElementById('modal-cat').classList.remove('hidden');
            }

            abrirModalCategoria() {
                this._nombreCatTemporal = null;
                document.getElementById('edit-cat-name').value = '';
                document.getElementById('edit-cat-price').value = '';
                document.getElementById('edit-cat-name').placeholder = "Nombre nueva categor√≠a";
                document.getElementById('modal-cat').classList.remove('hidden');
            }

            cerrarModal(id) {
                document.getElementById(id).classList.add('hidden');
            }

            guardarModalCategoria() {
                const nombre = document.getElementById('edit-cat-name').value;
                const precio = document.getElementById('edit-cat-price').value;

                if (!nombre || !precio) {
                    this.mostrarToast('Completa todos los campos'); return;
                }

                if (this._nombreCatTemporal) {
                    this.estado.actualizarCategoria(this._nombreCatTemporal, nombre, precio);
                    this.mostrarToast('Categor√≠a actualizada');
                } else {
                    this.estado.agregarCategoria(nombre, precio);
                    this.mostrarToast('Categor√≠a creada');
                }

                this.cerrarModal('modal-cat');
                this.renderizarConfiguracion();
            }

            eliminarCategoria(nombre) {
                this.mostrarModal(`¬øBorrar ${nombre}?`, 'Podr√°s agregarla de nuevo luego.', () => {
                    this.estado.eliminarCategoria(nombre);
                    this.renderizarConfiguracion();
                    this.mostrarToast('Categor√≠a eliminada');
                });
            }

            // Utilidades
            formatearDinero(valor) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(valor); }
            formatearMes(clave) {
                const [y, m] = clave.split('-');
                const fecha = new Date(y, m - 1);
                return fecha.toLocaleString('es-AR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
            }

            actualizarEncabezadoMes() {
                document.getElementById('current-month-display').textContent = this.formatearMes(this.mesActual);
            }

            mostrarModal(titulo, cuerpo, alConfirmar) {
                const m = this.elementos.modal;
                const contenido = this.elementos.contenidoModal;
                document.getElementById('modal-title').textContent = titulo;
                document.getElementById('modal-body').textContent = cuerpo;

                m.classList.remove('hidden');
                // Peque√±o retraso para animaci√≥n fade in
                setTimeout(() => m.classList.remove('opacity-0'), 10);
                setTimeout(() => contenido.classList.remove('scale-95'), 10);

                const btnOk = document.getElementById('modal-confirm');
                const btnCancelar = document.getElementById('modal-cancel');

                // Clonar para evitar duplicados de listeners
                const nuevoOk = btnOk.cloneNode(true);
                btnOk.parentNode.replaceChild(nuevoOk, btnOk);
                const nuevoCancelar = btnCancelar.cloneNode(true);
                btnCancelar.parentNode.replaceChild(nuevoCancelar, btnCancelar);

                nuevoOk.addEventListener('click', () => {
                    alConfirmar();
                    this.cerrarModalGenerico();
                });
                nuevoCancelar.addEventListener('click', () => this.cerrarModalGenerico());
            }

            cerrarModalGenerico() {
                const m = this.elementos.modal;
                const contenido = this.elementos.contenidoModal;
                m.classList.add('opacity-0');
                contenido.classList.add('scale-95');
                setTimeout(() => m.classList.add('hidden'), 300);
            }

            mostrarToast(mensaje, tipo = 'success') {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').textContent = mensaje;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }

            exportarDatos() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.estado.partidos, null, 2));
                const nodoDescarga = document.createElement('a');
                nodoDescarga.setAttribute("href", dataStr);
                nodoDescarga.setAttribute("download", "basquet_backup_" + Date.now() + ".json");
                document.body.appendChild(nodoDescarga);
                nodoDescarga.click();
                nodoDescarga.remove();
                this.mostrarToast('Copia de seguridad descargada');
            }
        }

        // INICIALIZACI√ìN
        const estadoApp = new EstadoAplicacion();
        const interfazUsuario = new InterfazUsuario(estadoApp);

        // Registro de Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW registrado con √©xito:', registration.scope);
                    })
                    .catch(err => {
                        console.log('Fallo al registrar SW:', err);
                    });
            });
        }

    </script>
</body>

</html>